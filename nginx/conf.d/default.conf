server {
    listen 80;

    server_name lyacos.net www.lyacos.net lyacos.ovh www.lyacos.ovh;

    index index.php index.html;
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
    root /var/www/public;

    # ESCLUSIONI CACHE
    set $no_cache 0;
    if ($request_uri ~ "^/admin/|^/home") {
        set $no_cache 1;
    }

    # 1. CACHE STATICA (Browser-side cache)
    location ~* \.(css|js|gif|jpe?g|png|ico|woff|woff2|eot|ttf|svg)$ {
        expires 30d;
        add_header Cache-Control "public, must-revalidate";
        try_files $uri =404;
    }
    
    # 2. GESTIONE DEI FILE PHP
    # *** QUESTO BLOCCO DEVE ESSERCI PER ESEGUIRE PHP-FPM ***
    location ~ \.php$ {
        # Per Laravel, tutte le richieste PHP devono andare ad 'app:9000'
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # 3. FULL PAGE CACHE (FPC) di Nginx e Fallback a index.php
    location / {
        # Tenta di servire l'asset statico, altrimenti passa il controllo a index.php
        try_files $uri $uri/ /index.php?$query_string;
        
        # PARAMETRI FPC (Qui li applichiamo alla risposta index.php)
        proxy_cache lyacos_cache;                 
        proxy_cache_key $scheme$host$request_uri; 
        proxy_cache_methods GET HEAD;
        proxy_cache_valid 200 60m;
        
        # APPLICAZIONE DELLE ESCLUSIONI
        proxy_cache_bypass $http_cookie $no_cache; 
        proxy_no_cache $no_cache;
    }
}